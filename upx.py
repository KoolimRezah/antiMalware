import os
import pefile
import re

curPath = os.path.dirname(os.path.abspath(__file__))


def _isUPX(peFile):
    """

    :param peFile:
    :return:
    """
    pe = peFile
    flag1 = False
    for section in pe.sections:
        if re.search('UPX0', section.Name):
            flag = True
        elif re.search('UPX1', section.Name) and flag:
            return True
    return False


def isUPX(pePath):
    pe = pefile.PE(pePath)
    result = _isUPX(pe)
    pe.close()
    return result


def unpackUPX(pePath):
    pe = pefile.PE(pePath)
    if not _isUPX(pe):
        return False
    upx = os.path.join(curPath, 'upx391w')
    upx = os.path.join(upx, "upx.exe")
    pe.close()
    os.system(upx + " -d " + pePath)


# if __name__=='__main__':
# unpackUPX(r'D:\Temp\magshimim\Project\fileSend\upx391w\upxCopy.exe')
